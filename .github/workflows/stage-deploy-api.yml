name: Stage - Deploy API

on:
  workflow_call:
    inputs:
      run: { required: true, type: boolean }
      environment: { required: true, type: string }
      api_source_tag: { required: true, type: string }
      api_version_tag: { required: false, default: '', type: string }
    secrets:
      DOCKER_USERNAME: { required: true }
      DOCKER_PASSWORD: { required: true }
      DEPLOY_API_SSH_KEY: { required: true }
      DEPLOY_API_SSH_USER: { required: true }
      API_DB_USER: { required: false }
      API_DB_PASSWORD: { required: false }
      API_AWS_ACCESS_KEY: { required: false }
      API_AWS_SECRET_KEY: { required: false }

jobs:
  deploy-api:
    if: ${{ inputs.run }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up buildx
        uses: docker/setup-buildx-action@v3

      - name: Promote image (src -> version)
        if: ${{ inputs.api_version_tag != '' }}
        shell: bash
        run: |
          set -euo pipefail
          docker buildx imagetools create \
            -t "${{ vars.DOCKER_REPO }}:${{ inputs.api_version_tag }}" \
            "${{ vars.DOCKER_REPO }}:${{ inputs.api_source_tag }}"

      - name: Promote image (version/src -> env tag)
        shell: bash
        run: |
          set -euo pipefail
          from_tag="${{ inputs.api_source_tag }}"
          if [[ "${{ inputs.api_version_tag }}" != "" ]]; then
            from_tag="${{ inputs.api_version_tag }}"
          fi

          docker buildx imagetools create \
            -t "${{ vars.DOCKER_REPO }}:${{ vars.DOCKER_API_IMAGE_TAG }}" \
            "${{ vars.DOCKER_REPO }}:${from_tag}"

          echo "DEPLOY_TAG=${{ vars.DOCKER_API_IMAGE_TAG }}" >> "$GITHUB_ENV"
          echo "APP_VERSION=${from_tag}" >> "$GITHUB_ENV"

      - name: Set up SSH key
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.DEPLOY_API_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Add known host
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ vars.DEPLOY_API_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Generate .env
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "API_DB_HOST=${{ vars.API_DB_HOST }}"
            echo "API_DB_PORT=${{ vars.API_DB_PORT }}"
            echo "API_DB_DATABASE=${{ vars.API_DB_DATABASE }}"
            echo "API_DB_USER=${{ secrets.API_DB_USER }}"
            echo "API_DB_PASSWORD=${{ secrets.API_DB_PASSWORD }}"
            echo "API_AWS_ACCESS_KEY=${{ secrets.API_AWS_ACCESS_KEY }}"
            echo "API_AWS_SECRET_KEY=${{ secrets.API_AWS_SECRET_KEY }}"
            echo "API_AWS_REGION=${{ vars.API_AWS_REGION }}"
            echo "API_AWS_S3_BUCKET_NAME=${{ vars.API_AWS_S3_BUCKET_NAME }}"
            echo "API_ALLOWED_ORIGINS=${{ vars.API_ALLOWED_ORIGINS }}"
            echo "DOCKER_API_IMAGE_TAG=${{ env.DEPLOY_TAG }}"
            echo "DOCKER_REPO=${{ vars.DOCKER_REPO }}"
          } > .env

      - name: Upload .env
        shell: bash
        run: |
          set -euo pipefail
          scp -i key.pem .env "${{ secrets.DEPLOY_API_SSH_USER }}@${{ vars.DEPLOY_API_SSH_HOST }}:~/"

      - name: Move .env into /opt/docker
        shell: bash
        run: |
          set -euo pipefail
          ssh -i key.pem "${{ secrets.DEPLOY_API_SSH_USER }}@${{ vars.DEPLOY_API_SSH_HOST }}" '
            sudo mv -f ~/\.env /opt/docker/.env
          '

      - name: Restart docker compose (health-gated)
        shell: bash
        run: |
          set -euo pipefail
          ssh -i key.pem "${{ secrets.DEPLOY_API_SSH_USER }}@${{ vars.DEPLOY_API_SSH_HOST }}" <<'EOF'
            set -e
            cd /opt/docker

            docker compose down
            docker compose pull

            set +e
            docker compose up -d --wait --wait-timeout 120
            rc=$?
            set -e

            if [ $rc -ne 0 ]; then
              echo "❌ Some services failed or became unhealthy:"
              docker compose ps
              echo "— recent logs from all services —"
              docker compose logs --tail=200
              exit $rc
            fi

            echo "✅ All services are healthy:"
            docker compose ps
          EOF