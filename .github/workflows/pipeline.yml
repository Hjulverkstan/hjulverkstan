name: Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      build:
        description: 'Which modules to build (auto/api/web/both)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - api
          - web
          - both

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      api_changes: ${{ steps.decide.outputs.api }}
      web_changes: ${{ steps.decide.outputs.web }}
      trace_tag: ${{ steps.trace.outputs.trace_tag }}
    steps:
      - uses: actions/checkout@v3

      - name: Determine trace tag
        id: trace
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          branch="${{ github.ref_name }}"

          if [[ "$branch" == "main" ]]; then
            shortsha=$(git rev-parse --short=6 HEAD)
            echo "trace_tag=$shortsha" >> $GITHUB_OUTPUT
            echo "âœ… Trace tag (commit): $shortsha"
          elif [[ "$branch" =~ ^hotfix([/-].*|$) ]]; then
            shortsha=$(git rev-parse --short=6 HEAD)
            tag="hotfix-${shortsha}"
            echo "trace_tag=$tag" >> $GITHUB_OUTPUT
            echo "âœ… Trace tag (hotfix-commit): $tag"
          else
            pr=$(gh pr list --head "$branch" --state open --json number --jq '.[0].number' || true)
            if [[ -n "$pr" ]]; then
              echo "trace_tag=pr-$pr" >> $GITHUB_OUTPUT
              echo "âœ… Trace tag (PR number): pr-$pr"
            else
              echo "ðŸš« Dispatch did not match rules."
              exit 1
            fi
          fi

      - name: Detect module file changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            api:
              - 'api/**'
              - '.github/actions/**'
              - '.github/workflows/**'
            web:
              - 'web/**'
              - '.github/actions/**'
              - '.github/workflows/**'

      - name: Decide final build flags (respect manual input)
        id: decide
        shell: bash
        run: |
          api="${{ steps.changes.outputs.api }}"
          web="${{ steps.changes.outputs.web }}"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            case "${{ github.event.inputs.build }}" in
              api)  api=true;  web=false ;;
              web)  api=false; web=true  ;;
              both) api=true;  web=true  ;;
              *)    : ;;
            esac
          fi

          echo "api=$api" >> "$GITHUB_OUTPUT"
          echo "web=$web" >> "$GITHUB_OUTPUT"

  test:
    name: Test
    needs: init
    if: ${{ needs.init.outputs.api_changes == 'true' || needs.init.outputs.web_changes == 'true' }}
    uses: ./.github/workflows/stage-test.yml
    with:
      run_api_tests: ${{ needs.init.outputs.api_changes == 'true' }}
      run_web_build: false
    secrets: inherit

  build:
    name: Build â€“ Generate and publish docker image
    needs: [init, test]
    if: ${{ needs.init.outputs.api_changes == 'true' }}
    uses: ./.github/workflows/stage-build.yml
    with:
      build_api: true
      trace_tag: ${{ needs.init.outputs.trace_tag }}
    secrets: inherit

  deploy-dev:
    name: Deploy (dev) â€“ Promote image + build web  deploy
    needs: [init, test, build]
    if: ${{ needs.init.outputs.api_changes == 'true' || needs.init.outputs.web_changes == 'true' }}
    uses: ./.github/workflows/stage-deploy.yml
    with:
      environment: dev
      deploy_api: ${{ needs.init.outputs.api_changes == 'true' }}
      deploy_web: ${{ needs.init.outputs.web_changes == 'true' }}

      api_source_tag: ${{ needs.init.outputs.trace_tag }}
    secrets: inherit
