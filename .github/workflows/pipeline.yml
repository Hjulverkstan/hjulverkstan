name: Deploy

on:
  push:
    branches: [main]
    tags:
      - "v*-rc.*"
      - "v*"

  workflow_dispatch:
    inputs:
      mode:
        description: "Which modules to deploy (auto/api/web/both)"
        required: false
        default: "auto"
        type: choice
        options: [auto, api, web, both]

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.route.outputs.environment }}
      release_tag: ${{ steps.route.outputs.release_tag }}
      short_commit_tag: ${{ steps.route.outputs.short_commit_tag }}
      deploy_api: ${{ steps.route.outputs.deploy_api }}
      deploy_web: ${{ steps.route.outputs.deploy_web }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect module file changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          base: main
          filters: |
            api:
              - 'api/**'
              - '.github/actions/**'
            web:
              - 'web/**'
              - '.github/actions/**'

      - name: Determine needed variables for pipeline routing
        id: route
        shell: bash
        run: |
          set -euo pipefail
          
          is_release=false
          environment=dev
          release_tag=""
          mode="${{ github.event.inputs.mode || 'auto' }}"
          
          changed_api="${{ steps.changes.outputs.api }}"
          changed_web="${{ steps.changes.outputs.web }}"
          deploy_api=false
          deploy_web=false
          
          short_commit_tag=$(git rev-parse --short=6 HEAD)
          
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            mode="both"
            is_release=true
            release_tag="${{ github.ref_name }}"
          
            environment=prod
            [[ "$release_tag" == *"-rc."* ]] && environment=test
          fi
          
          case "$mode" in
            api) deploy_api=true ;;
            web) deploy_web=true ;;
            both) deploy_api=true; deploy_web=true ;;
            auto) deploy_api="$changed_api"; deploy_web="$changed_web" ;;
          esac
          
          echo "environment=$environment" >> "$GITHUB_OUTPUT"
          echo "is_release=$is_release" >> "$GITHUB_OUTPUT"
          echo "release_tag=$release_tag" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "deploy_api=$deploy_api" >> "$GITHUB_OUTPUT"
          echo "deploy_web=$deploy_web" >> "$GITHUB_OUTPUT"
          echo "short_commit_tag=$short_commit_tag" >> "$GITHUB_OUTPUT"
          
          {
            echo "### Deploying to **$environment**"
            echo ""
            [[ "$is_release" == true ]] && echo "- Release tag: **${release_tag:-<none>}**"
            echo "- Deployment mode: **$mode**"
            echo "- Deploy API: **$deploy_api** (detected changes: $changed_api)"
            echo "- Deploy Web: **$deploy_web** (detected changes: $changed_web)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Guardrails (release tags must be semver + tag commit on main)
        if: ${{ steps.route.outputs.is_release == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          tag="${{ steps.route.outputs.release_tag }}"

          if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$ ]]; then
            echo "❌ Tag must follow semver: vX.Y.Z or vX.Y.Z-rc.N. Got: $tag"
            exit 1
          fi

          git fetch origin main --no-tags
          if ! git merge-base --is-ancestor "${GITHUB_SHA}" "origin/main"; then
            echo "❌ Tag commit (${GITHUB_SHA}) is not reachable from origin/main"
            exit 1
          fi

          echo "✅ Release guardrails passed"

  test:
    name: Test
    needs: init
    if: ${{ needs.init.outputs.deploy_api == 'true' || needs.init.outputs.deploy_web == 'true' }}
    uses: ./.github/workflows/stage-test.yml
    with:
      run_api_tests: ${{ needs.init.outputs.deploy_api == 'true' }}
      run_web_build: ${{ needs.init.outputs.deploy_web == 'true' }}
    secrets: inherit

  build-api:
    name: Build API image
    needs: [init, test]
    uses: ./.github/workflows/stage-build-api.yml
    with:
      run: ${{ needs.init.outputs.deploy_api == 'true' }}
      environment: ${{ needs.init.outputs.environment }}
      short_commit_tag: ${{ needs.init.outputs.short_commit_tag }}
    secrets: inherit

  deploy-api:
    name: Deploy API
    needs: [init, build-api]
    uses: ./.github/workflows/stage-deploy-api.yml
    with:
      run: ${{ needs.init.outputs.deploy_api == 'true' }}
      environment: ${{ needs.init.outputs.environment }}
      api_source_tag: ${{ needs.init.outputs.short_commit_tag }}
      api_version_tag: ${{ needs.init.outputs.release_tag }}
    secrets: inherit

  build-web:
    name: Build Web
    needs: [init, test]
    uses: ./.github/workflows/stage-build-web.yml
    with:
      run: ${{ needs.init.outputs.deploy_web == 'true' }}
      environment: ${{ needs.init.outputs.environment }}
    secrets: inherit

  deploy-web:
    name: Deploy Web
    needs: [init, deploy-api, build-web]
    uses: ./.github/workflows/stage-deploy-web.yml
    with:
      run: ${{ needs.init.outputs.deploy_web == 'true' }}
      environment: ${{ needs.init.outputs.environment }}
      app_version: ${{ needs.init.outputs.release_tag != '' && needs.init.outputs.release_tag || 'dev' }}
    secrets: inherit