> Welcome to the aws architecture module of the Hjulverkstan monorepo, here is a [link](../README.md) to the main project readme.

This documentation pertains to both AWS's CDK and the GitHub Actions pipelines

## UML Diagram


## Background

### Architecture 

`TODO: Talk about infra as code`

`TODO: Fill in more about the approach used with CDK`

`TODO: Talk about how we use ec2 and docker compose`

`TODO: Talk about the idea behind environments and pipelines, docker releases, trunk based development etc.`

<div>
    <img src="aws.drawio.svg">
</div>

## CDK Pre Deploy

Install dependencies

```bash
npm i
```

Build the .js files

```bash
npm run build
```

## CDK Deploy

The cdk code is written to take a context value of `reason=setup` or `reason=deploy`, like so:

```bash
cdk deploy -c reason=setup
```

Because the stacks `CertStack` and `LambdaStack` are executed in the `us-east-1` region and can therefore not be referenced in the `AppStack` because of the nature of CloudFormation. with the `AppStack` being in a different region, for the `AppStack` to be successfully deployed we need reference the ARN's (the unique Amazon Resource Numbers) of the resources that the `AppStack` is dependent on instead.

During the deployment with `reason=setup` the ARN's don't exist and the following env vars are required (recommended to be added to the root `.env` of the repo, you may copy `.env.template` for this):

- `CDK_ACCOUNT`: Your aws account with deploy permissions
- `CDK_APEX_DOMAIN`: The apex domain of the site, that is the root domain without subdomains, i.e `hjulverkstan.org`
- `CDK_SITE_RECORD_NAME`: This is the subdomain to publish the site to, i.e. `dev` or just `""` empty string for prod.

But when deploying the `AppStack` the ARN's must also be added the env vars, these are all logged to stdout during deployment with `reason=setup`:

- `CDK_SITE_CERT_ARN`: This is the ARN exposed when running the Cert Stack`.
- `CDK_ROUTING_LAMBDA_ARN`: This is the lambda version ARN exposed when running the Lambda Stack.

All right, onto deploying everything.

To be run once by developer to get the ARN's and input to either to local env vars and or GitHub Action secrets for pipelines:

```bash
cdk bootstrap -c reason=setup
cdk deploy -c reason=setup
```

To then be run locally or automatically by the pipeline:

```bash
cdk bootstrap -c reason=deploy --all
cdk deploy -c reason=deploy --all
```

And naturally if one want to deploy just one stack for testing purposes one can for instance:

```bash
cdk deploy -c reason=deploy AppStack/WebStack
```

## Adding users with ssh access to the server

Through the aws ec2 console or if you already have ssh access:

```bash
cd /opt/docker
sh create-ssh-user.sh
```

This will prompt for username and ssh key and will resolve ssh access, user groups and sudoer rights...

### GitHub Actions Secrets

The following vars are needed for the pipelines actions themselves:

- `DOCKER_REPO`: To push to on docker hub, currently using Alten's org `anorden/hjulverkstan-api`.
- `DOCKER_API_IMAGE_TAG`: For dev env ´dev-release´, later for test/production `test-release` and just `release`.
- `DEPLOY_API_STARTUP_TIMEOUT`: A reasonable 90s perhaps
- `DEPLOY_WEB_BUCKET_NAME`: The bucket `SiteBucket` generated by cdk.
- `DEPLOY_WEB_CLOUDFRONT_DISRTIBUTION_ID`: The id of the distribution.

And the secrets:
 
- `DOCKER_USERNAME`
- `DOCKER_PASSWORD`
- `DEPLOY_API_SSH_HOST`
- `DEPLOY_API_SSH_USER`
- `DEPLOY_API_SSH_KEY`
- `DEPLOY_ACCESS_KEY`
- `DEPLOY_SECRET_KEY`

But the pipelines also needs all the env vars prefixed `API_` and `VITE_`, see the .env.template file. This is so that it can build the web app and copy the needed env vars into the ec2 instance for the docker compose cluster to have the right values.
