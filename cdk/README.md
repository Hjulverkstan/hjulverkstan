> Welcome to the aws architecture module of the Hjulverkstan monorepo, here is a [link](../README.md) to the main project readme.

This documentation pertains to both AWS's CDK and the Github Actions pipelines

## Background

### Architecture 

`TODO: Talk about infra as code`

`TODO: Fill in more about the approach used with CDK`

`TODO: Svg diagram from draw.io saved with editability`

`TODO: Talk about how we use ec2 and docker compose`

`TODO: Talk about the idea behind environments and pipelines, docker releases, trunk based development etc.`

A brief comment regarding the CI/CD and local deploy is that the env vars for ec2 and the starting of docker compose is not part of the setup.sh script that the ec2 runs upon cdk deployment.

This is thought to be a separate pipeline stage to be run after, the deploy env vars run docker-compose down and up.

And during local deployment by developer one has to scp the .env file into place, that is `/opt/docker/.env`...

The env vars that are needed to run docker-compose is all the env-vars that are prefixed with `API`


## Guide

### CDK Setup

Install dependencies

```bash
npm i
```

Build the .js files

```bash
npm run build
```

### Deploy CDK Certificate Stack

This stack is for manual deployment by developer, it creates the global certificate used by CloudFront and outputs the ARN id to the console that is needed for the App Stack.

Required environment variables to be populated directly in bash or in the root .env (recommended, you can copy the root .env.templates and fill in values):

- `CDK_ACCOUNT`: Your aws account with deploy permissions
- `CDK_APEX_DOMAIN`: The apex domain of the site, that is the root domain without subdomains, i.e `hjulverkstan.org`
- `CDK_SITE_RECORD_NAME`: This is the subdomain to publish the site to, i.e. `dev` or just `""` empty string for prod. 

Bootstrap and deploy

```bash
cdk bootstrap -c stack=cert
cdk deploy -c stack=cert
```

### Deploy CDK App Stack

This is the stack of the application, to be automatically deployed by CI/CD but should naturally be manually deployed for testing when making changes to the stack.

Required environment variables to be populated directly in bash or in the root .env (recommended, you can copy the root .env.templates and fill in values):

- `CDK_ACCOUNT`: Your aws account with deploy permissions
- `CDK_APEX_DOMAIN`: The apex domain of the site, that is the root domain without subdomains, i.e `hjulverkstan.org`
- `CDK_SITE_RECORD_NAME`: This is the subdomain to publish the site to, i.e. `dev` or just `""` empty string for prod.
- `CDK_SITE_CERT_ARN`: This is the ARN exposed when running the Cert Stack.

Bootstrap and deploy, with both sub-stack using --all:

```bash
cdk bootstrap -c stack=app
cdk bootstrap -c stack=app --all
```

### Adding users with ssh access to the server

Through the aws ec2 console or if you already have ssh access:

```bash
cd /opt/docker
sh create-ssh-user.sh
```

This will prompt for username and ssh key and will resolve ssh access, user groups and sudoer rights...

### GitHub Actions Secrets

The following vars are needed for the pipelines actions themselves:

- `DOCKER_REPO`: To push to on docker hub, currently using Alten's org `anorden/hjulverkstan-api`.
- `DOCKER_API_IMAGE_TAG`: For dev env ´dev-release´, later for test/production `test-release` and just `release`.
- `DEPLOY_API_STARTUP_TIMEOUT`: A reasonable 90s perhaps
- `DEPLOY_WEB_BUCKET_NAME`: The bucket `SiteBucket` generated by cdk.
- `DEPLOY_WEB_CLOUDFRONT_DISRTIBUTION_ID`: The id of the distribution.

And the secrets:
 
- `DOCKER_USERNAME`
- `DOCKER_PASSWORD`
- `DEPLOY_API_SSH_HOST`
- `DEPLOY_API_SSH_USER`
- `DEPLOY_API_SSH_KEY`
- `DEPLOY_ACCESS_KEY`
- `DEPLOY_SECRET_KEY`

But the pipelines also needs all the env vars prefixed `API_` and `VITE_`, see the .env.template file. This is so that it can build the web app and copy the needed env vars into the ec2 instance for the docker compose cluster to have the right values.
